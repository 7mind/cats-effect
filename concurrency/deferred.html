<html><head><title>Cats Effect: Deferred</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Cats Effect contributors" /><meta name="description" content="The IO Monad for Scala" /><meta name="og:image" content="/cats-effect/img/poster.png" /><meta name="og:title" content="Cats Effect: Deferred" /><meta name="og:site_name" content="Cats Effect" /><meta name="og:url" content="https://typelevel.org/cats-effect/" /><meta name="og:type" content="website" /><meta name="og:description" content="The IO Monad for Scala" /><link rel="icon" type="image/png" href="/cats-effect/img/favicon.png" /><meta name="twitter:title" content="Cats Effect: Deferred" /><meta name="twitter:image" content="https://typelevel.org/cats-effect/img/poster.png" /><meta name="twitter:description" content="The IO Monad for Scala" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:creator" content="@typelevel" /><link rel="icon" type="image/png" sizes="16x16" href="/cats-effect/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/cats-effect/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/cats-effect/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/cats-effect/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/cats-effect/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/cats-effect/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/cats-effect/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/cats-effect/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/cats-effect/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/cats-effect/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/cats-effect/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/cats-effect/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/cats-effect/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/cats-effect/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/cats-effect/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/cats-effect/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/cats-effect/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/cats-effect/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/cats-effect/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/cats-effect/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/cats-effect/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/cats-effect/css/style.css" /><link rel="stylesheet" href="/cats-effect/css/palette.css" /><link rel="stylesheet" href="/cats-effect/css/codemirror.css" /><link rel="stylesheet" href="/cats-effect/css/toc.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/cats-effect/" class="brand"><div class="brand-wrapper"><span>Cats Effect</span></div></a></li> <li><a href="/cats-effect/datatypes/" class="">Data Types</a> <ul class="sub_section"> <li><a href="/cats-effect/datatypes/io.html" class="">IO</a></li> <li><a href="/cats-effect/datatypes/fiber.html" class="">Fiber</a></li> <li><a href="/cats-effect/datatypes/resource.html" class="">Resource</a></li> <li><a href="/cats-effect/datatypes/timer.html" class="">Timer</a></li></ul></li> <li><a href="/cats-effect/concurrency/" class="">Concurrency</a> <ul class="sub_section"> <li><a href="/cats-effect/concurrency/deferred.html" class=" active ">Deferred</a></li> <li><a href="/cats-effect/concurrency/mvar.html" class="">MVar</a></li> <li><a href="/cats-effect/concurrency/ref.html" class="">Ref</a></li> <li><a href="/cats-effect/concurrency/semaphore.html" class="">Semaphore</a></li></ul></li> <li><a href="/cats-effect/typeclasses/" class="">Type Classes</a> <ul class="sub_section"> <li><a href="/cats-effect/typeclasses/bracket.html" class="">Bracket</a></li> <li><a href="/cats-effect/typeclasses/sync.html" class="">Sync</a></li> <li><a href="/cats-effect/typeclasses/liftio.html" class="">LiftIO</a></li> <li><a href="/cats-effect/typeclasses/async.html" class="">Async</a></li> <li><a href="/cats-effect/typeclasses/concurrent.html" class="">Concurrent</a></li> <li><a href="/cats-effect/typeclasses/effect.html" class="">Effect</a></li> <li><a href="/cats-effect/typeclasses/concurrent-effect.html" class="">ConcurrentEffect</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/typelevel/cats-effect"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/typelevel/cats-effect"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Cats Effect The IO Monad for Scala');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Cats Effect The IO Monad for Scala');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="typelevel" data-github-repo="cats-effect"><div class="content-wrapper"><section><h1>Deferred</h1>

<p>A purely functional synchronization primitive which represents a single value which may not yet be available.</p>

<p>When created, a <code class="highlighter-rouge">Deferred</code> is empty. It can then be completed exactly once, and never be made empty again.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">abstract</span> <span class="k">class</span> <span class="nc">Deferred</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">get</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">complete</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="expected-behavior-of-get">Expected behavior of <code class="highlighter-rouge">get</code></h3>

<ul>
  <li><code class="highlighter-rouge">get</code> on an empty <code class="highlighter-rouge">Deferred</code> will block until the <code class="highlighter-rouge">Deferred</code> is completed.</li>
  <li><code class="highlighter-rouge">get</code> on a completed <code class="highlighter-rouge">Deferred</code> will always immediately return its content.</li>
</ul>

<h3 id="expected-behavior-of-complete">Expected behavior of <code class="highlighter-rouge">complete</code></h3>

<ul>
  <li><code class="highlighter-rouge">complete(a)</code> on an empty <code class="highlighter-rouge">Deferred</code> will set it to <code class="highlighter-rouge">a</code>, and notify any and all readers currently blocked on a call to <code class="highlighter-rouge">get</code>.</li>
  <li><code class="highlighter-rouge">complete(a)</code> on a <code class="highlighter-rouge">Deferred</code> that has already been completed will not modify its content, and result in a failed <code class="highlighter-rouge">F</code>.</li>
</ul>

<h3 id="notes">Notes</h3>

<p>Albeit simple, <code class="highlighter-rouge">Deferred</code> can be used in conjunction with <code class="highlighter-rouge">Ref</code> to build complex concurrent behaviour and data structures like queues and semaphores.</p>

<p>Finally, the blocking mentioned above is semantic only, no actual threads are blocked by the implementation.</p>

<h3 id="only-once">Only Once</h3>

<p>Whenever you are in a scenario when many processes can modify the same value but you only care about the first one in doing so and stop processing, then this is a great use case of <code class="highlighter-rouge">Deferred[F, A]</code>.</p>

<p>Two processes will try to complete at the same time but only one will succeed, completing the deferred primitive exactly once. The loser one will raise an error when trying to complete a deferred already completed and automatically be canceled by the <code class="highlighter-rouge">IO.race</code> mechanism, thatâ€™s why we call attempt on the evaluation.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.Parallel</span>
<span class="c1">// &lt;console&gt;:12: warning: Unused import
//        import cats.Parallel
//                    ^
// import cats.Parallel
</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Concurrent</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="c1">// &lt;console&gt;:9: warning: Unused import
//        import cats.Parallel
//                    ^
// &lt;console&gt;:13: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                            ^
// &lt;console&gt;:13: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                                        ^
// import cats.effect.{Concurrent, IO}
</span>
<span class="k">import</span> <span class="nn">cats.effect.concurrent.Deferred</span>
<span class="c1">// &lt;console&gt;:9: warning: Unused import
//        import cats.Parallel
//                    ^
// &lt;console&gt;:10: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                            ^
// &lt;console&gt;:10: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                                        ^
// &lt;console&gt;:14: warning: Unused import
//        import cats.effect.concurrent.Deferred
//                                      ^
// import cats.effect.concurrent.Deferred
</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="c1">// &lt;console&gt;:9: warning: Unused import
//        import cats.Parallel
//                    ^
// &lt;console&gt;:10: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                            ^
// &lt;console&gt;:10: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                                        ^
// &lt;console&gt;:11: warning: Unused import
//        import cats.effect.concurrent.Deferred
//                                      ^
// &lt;console&gt;:15: warning: Unused import
//        import cats.implicits._
//                              ^
// import cats.implicits._
</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
<span class="c1">// &lt;console&gt;:9: warning: Unused import
//        import cats.Parallel
//                    ^
// &lt;console&gt;:10: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                            ^
// &lt;console&gt;:10: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                                        ^
// &lt;console&gt;:11: warning: Unused import
//        import cats.effect.concurrent.Deferred
//                                      ^
// &lt;console&gt;:13: warning: Unused import
//        import cats.implicits._
//                              ^
// &lt;console&gt;:18: warning: Unused import
//        import scala.concurrent.ExecutionContext.Implicits.global
//                                                           ^
// import scala.concurrent.ExecutionContext.Implicits.global
</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">par</span><span class="k">:</span> <span class="kt">Parallel</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Parallel</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">IO.Par</span><span class="o">].</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">Parallel</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">IO</span><span class="o">]]</span>
<span class="c1">// &lt;console&gt;:10: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                            ^
// &lt;console&gt;:11: warning: Unused import
//        import cats.effect.concurrent.Deferred
//                                      ^
// &lt;console&gt;:13: warning: Unused import
//        import cats.implicits._
//                              ^
// par: cats.Parallel[cats.effect.IO,cats.effect.IO] = cats.effect.IOInstances$$anon$4@4d12b561
</span>
<span class="k">def</span> <span class="n">start</span><span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">Deferred</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">attemptCompletion</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="nc">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="n">n</span> <span class="k">=&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">complete</span><span class="o">(</span><span class="n">n</span><span class="o">).</span><span class="n">attempt</span><span class="o">.</span><span class="n">void</span>

  <span class="nc">List</span><span class="o">(</span>
    <span class="nc">IO</span><span class="o">.</span><span class="n">race</span><span class="o">(</span><span class="n">attemptCompletion</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">attemptCompletion</span><span class="o">(</span><span class="mi">2</span><span class="o">)),</span>
    <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">n</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Result: $n"</span><span class="o">))</span> <span class="o">}</span>
  <span class="o">).</span><span class="n">parSequence</span><span class="o">.</span><span class="n">void</span>
<span class="o">}</span>
<span class="c1">// &lt;console&gt;:9: warning: Unused import
//        import cats.Parallel
//                    ^
// &lt;console&gt;:10: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                            ^
// start: (d: cats.effect.concurrent.Deferred[cats.effect.IO,Int])cats.effect.IO[Unit]
</span>
<span class="k">val</span> <span class="n">program</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">d</span> <span class="k">&lt;-</span> <span class="nc">Deferred</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span><span class="o">]</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">start</span><span class="o">(</span><span class="n">d</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
<span class="c1">// &lt;console&gt;:9: warning: Unused import
//        import cats.Parallel
//                    ^
// &lt;console&gt;:10: warning: Unused import
//        import cats.effect.{Concurrent, IO}
//                            ^
// &lt;console&gt;:13: warning: Unused import
//        import cats.implicits._
//                              ^
// &lt;console&gt;:16: warning: Unused import
//        import par
//                                            ^
// program: cats.effect.IO[Unit] = IO$807377035
</span></code></pre></div></div>


<link rel="stylesheet" type="text/css" href="/cats-effect/css/toc.css"></link>
<script type="text/javascript" src="/cats-effect/js/toc.js"></script>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/cats-effect/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/cats-effect/js/toc.js"></script><script>((window.gitter = {}).chat = {}).options = {
room: 'typelevel/cats-effect'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/cats-effect/js/main.js"></script></body></html>